# Solana Transfer Frontend

A Next.js 14 app-router frontend with NextAuth.js social authentication (Google & GitHub), Clerk-inspired dark UI, protected routes, and Solana public-key validation for secure token transfers.

---

## Environment Variables

Create a `.env.local` file in the `frontend/` directory with the following variables:

```bash
# NextAuth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-super-secret-key-min-32-chars-generate-with-openssl-rand-base64-32

# Google OAuth (obtain from https://console.cloud.google.com/apis/credentials)
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret

# GitHub OAuth (obtain from https://github.com/settings/developers)
GITHUB_ID=your-github-oauth-app-client-id
GITHUB_SECRET=your-github-oauth-app-client-secret

# Backend API
NEXT_PUBLIC_BACKEND_URL=http://localhost:4000

# Optional: Email provider (for magic link sign-in)
EMAIL_SERVER_HOST=smtp.example.com
EMAIL_SERVER_PORT=587
EMAIL_SERVER_USER=your-email@example.com
EMAIL_SERVER_PASS=your-email-password
EMAIL_FROM=noreply@example.com
```

**Generate `NEXTAUTH_SECRET`:**
```bash
openssl rand -base64 32
```

---

## OAuth Setup

### Google OAuth
1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create OAuth 2.0 Client ID
3. Add authorized redirect URI:
   - Local: `http://localhost:3000/api/auth/callback/google`
   - Production: `https://yourdomain.com/api/auth/callback/google`
4. Copy Client ID and Client Secret to `.env.local`

### GitHub OAuth
1. Go to [GitHub Developer Settings](https://github.com/settings/developers)
2. Create a new OAuth App
3. Set Authorization callback URL:
   - Local: `http://localhost:3000/api/auth/callback/github`
   - Production: `https://yourdomain.com/api/auth/callback/github`
4. Copy Client ID and Client Secret to `.env.local`

---

## Installation & Development

**Install dependencies:**
```bash
cd frontend
pnpm install
# or
npm install
```

**Run development server:**
```bash
pnpm dev
# or
npm run dev
```

Open [http://localhost:3000](http://localhost:3000)

**Build for production:**
```bash
pnpm build
# or
npm run build
```

**Start production server:**
```bash
pnpm start
# or
npm start
```

**Run tests:**
```bash
pnpm test
# or
npm test
```

---

## Backend Integration

### Expected Endpoints

#### 1. User Sync (POST `/api/users/sync`)
Called after successful sign-up to register user in backend.

**Request:**
```json
POST http://localhost:4000/api/users/sync
Authorization: Bearer <accessToken>
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com",
  "provider": "google",
  "providerId": "1234567890"
}
```

**Response:**
```json
{
  "success": true,
  "userId": "abc123"
}
```

#### 2. Transfer (POST `/api/transfer`)
Called from `/transfer` page to send Solana tokens.

**Request:**
```json
POST http://localhost:4000/api/transfer
Authorization: Bearer <accessToken>
Content-Type: application/json

{
  "recipientPublicKey": "11111111111111111111111111111111",
  "amount": 5.5
}
```

**Response (Success):**
```json
{
  "success": true,
  "transactionId": "5JxK7..."
}
```

**Response (Error):**
```json
{
  "success": false,
  "message": "Insufficient balance"
}
```

### Token Format

The `Authorization` header uses a Bearer token generated by NextAuth:
- If OAuth provider returns an `access_token`, it is forwarded.
- Otherwise, a mock JWT is generated server-side (see `lib/auth.ts`).
- **Production:** Replace `generateServerToken()` with proper JWT signing using `jsonwebtoken` and a shared secret with your backend.

**Example:**
```ts
import jwt from 'jsonwebtoken'

function generateServerToken(email: string): string {
  return jwt.sign(
    { email, iat: Date.now() },
    process.env.JWT_SECRET!,
    { expiresIn: '7d' }
  )
}
```

---

## Local Testing with OAuth

OAuth providers require public URLs. For local development:

### Option 1: ngrok
```bash
ngrok http 3000
# Use ngrok URL (e.g., https://abc123.ngrok.io) as NEXTAUTH_URL and in OAuth redirect URIs
```

### Option 2: Vercel Preview
```bash
vercel --prod
# Use Vercel preview URL in OAuth redirect URIs
```

---

## Deploy to Vercel

1. **Install Vercel CLI:**
```bash
npm i -g vercel
```

2. **Login:**
```bash
vercel login
```

3. **Deploy:**
```bash
cd frontend
vercel --prod
```

4. **Set environment variables in Vercel dashboard:**
   - Go to Project Settings → Environment Variables
   - Add all variables from `.env.local`
   - Update `NEXTAUTH_URL` to your production domain (e.g., `https://yourdomain.com`)

5. **Update OAuth redirect URIs:**
   - Google: Add `https://yourdomain.com/api/auth/callback/google`
   - GitHub: Add `https://yourdomain.com/api/auth/callback/github`

6. **Redeploy if needed:**
```bash
vercel --prod
```

---

## Project Structure

```
frontend/
├── app/                    # Next.js app router
│   ├── layout.tsx          # Root layout with dark mode provider
│   ├── page.tsx            # Home page
│   ├── signup/             # Sign-up page (social OAuth)
│   ├── signin/             # Sign-in page (social + email)
│   ├── transfer/           # Protected transfer page
│   └── api/auth/           # NextAuth API routes
├── components/             # Reusable UI components
│   ├── Modal.tsx
│   ├── SocialButton.tsx
│   ├── TransferForm.tsx    # Transfer form with validation
│   └── DarkModeToggle.tsx
├── lib/                    # Utilities
│   ├── auth.ts             # NextAuth configuration
│   ├── fetcher.ts          # Backend API calls
│   └── validation.ts       # Solana key & amount validation
├── __tests__/              # Jest unit tests
└── public/                 # Static assets
```

---

## Security & Gotchas

1. **CSRF Protection:**
   NextAuth uses httpOnly cookies with CSRF tokens by default. Ensure `NEXTAUTH_URL` matches your domain exactly (including protocol).

2. **Token Storage:**
   Session tokens are stored in httpOnly cookies (not localStorage) to prevent XSS attacks. Access tokens are exposed in the session object for backend API calls—consider using a server-side proxy in production to avoid exposing tokens client-side.

3. **CORS:**
   If your backend is on a different domain, configure CORS headers to allow `http://localhost:3000` (dev) and your production domain. Include `credentials: 'include'` in fetch calls if using cookies.

4. **OAuth Redirect Issues:**
   - Ensure redirect URIs in OAuth apps match `NEXTAUTH_URL` exactly (including trailing slashes).
   - For local dev with OAuth, use ngrok or Vercel preview URLs.
   - If you see "redirect_uri_mismatch", double-check the registered URIs in Google/GitHub.

5. **Solana Validation:**
   The `@solana/web3.js` PublicKey constructor throws on invalid keys. Always wrap validation in try-catch. The form validates client-side before submitting to the backend.

---

## Testing

Unit tests use Jest + React Testing Library. Current coverage:
- Invalid Solana public key validation
- Non-positive amount validation
- Successful transfer submission

**Run tests:**
```bash
pnpm test
```

**Watch mode:**
```bash
pnpm test:watch
```

---

## Notes

- Dark mode persists in `localStorage` and applies on initial load.
- Protected routes use NextAuth middleware (`middleware.ts`).
- Email magic-link provider is configured but requires SMTP credentials.
- Replace `generateServerToken()` in `lib/auth.ts` with proper JWT signing for production.
- Backend URL is configurable via `NEXT_PUBLIC_BACKEND_URL`.

---

**Ready to run. Paste files into `frontend/` and execute `pnpm install && pnpm dev`.**
